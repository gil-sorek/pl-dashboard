<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League xG Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, Fragment } = React;

        // Lucide React Icons as inline SVGs
        const RefreshCw = ({ className, style }) => (
            <svg className={className} style={style} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 2v6h-6"></path>
                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                <path d="M3 22v-6h6"></path>
                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
            </svg>
        );

        const Home = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
        );

        const Plane = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
            </svg>
        );

        const PremierLeagueDashboard = () => {
            const [teams, setTeams] = useState([]);
            const [players, setPlayers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('teams');
            const [positionFilter, setPositionFilter] = useState('ALL');
            const [groupByTeam, setGroupByTeam] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const bootstrapResponse = await fetch('https://fantasy.premierleague.com/api/bootstrap-static/');
                    const bootstrapData = await bootstrapResponse.json();
                    
                    const fixturesResponse = await fetch('https://fantasy.premierleague.com/api/fixtures/');
                    const fixturesData = await fixturesResponse.json();
                    
                    const teamsData = bootstrapData.teams.map(team => {
                        const teamFixtures = fixturesData
                            .filter(fixture => 
                                fixture.finished && 
                                (fixture.team_h === team.id || fixture.team_a === team.id)
                            )
                            .sort((a, b) => b.event - a.event)
                            .slice(0, 6)
                            .reverse()
                            .map(fixture => {
                                const isHome = fixture.team_h === team.id;
                                const opponent = bootstrapData.teams.find(t => 
                                    t.id === (isHome ? fixture.team_a : fixture.team_h)
                                );
                                
                                const xgc = isHome ? 
                                    (fixture.team_a_xg || 0) : 
                                    (fixture.team_h_xg || 0);
                                
                                return {
                                    gameweek: fixture.event,
                                    opponent: opponent.short_name,
                                    isHome: isHome,
                                    xgc: parseFloat(xgc).toFixed(2),
                                    score: isHome ? 
                                        `${fixture.team_h_score}-${fixture.team_a_score}` :
                                        `${fixture.team_a_score}-${fixture.team_h_score}`
                                };
                            });
                        
                        const totalXGC = teamFixtures.reduce((sum, f) => sum + parseFloat(f.xgc), 0);
                        const avgXGC = teamFixtures.length > 0 ? totalXGC / teamFixtures.length : 0;
                        
                        return {
                            id: team.id,
                            name: team.name,
                            shortName: team.short_name,
                            fixtures: teamFixtures,
                            avgXGC: avgXGC
                        };
                    });
                    
                    const playersData = bootstrapData.elements.map(player => {
                        const team = bootstrapData.teams.find(t => t.id === player.team);
                        let position = '';
                        switch(player.element_type) {
                            case 1: position = 'GK'; break;
                            case 2: position = 'DEF'; break;
                            case 3: position = 'MID'; break;
                            case 4: position = 'FWD'; break;
                        }
                        
                        return {
                            id: player.id,
                            name: player.web_name,
                            fullName: `${player.first_name} ${player.second_name}`,
                            team: team.short_name,
                            teamId: player.team,
                            position: position,
                            xG: parseFloat(player.expected_goals || 0),
                            xA: parseFloat(player.expected_assists || 0),
                            xGI: parseFloat(player.expected_goal_involvements || 0)
                        };
                    });

                    setTeams(teamsData);
                    setPlayers(playersData);
                    setLastUpdated(new Date());
                    
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
                setLoading(false);
            };

            useEffect(() => {
                fetchData();
            }, []);

            const getColorForXGC = (value, min, max) => {
                if (max === min) return 'rgb(34, 197, 94)';
                const normalized = (value - min) / (max - min);
                
                if (normalized < 0.33) {
                    return `rgb(34, 197, 94)`;
                } else if (normalized < 0.66) {
                    return `rgb(234, 179, 8)`;
                } else {
                    return `rgb(239, 68, 68)`;
                }
            };

            const getColorForValue = (value, min, max) => {
                if (max === min) return 'rgb(34, 197, 94)';
                const normalized = (value - min) / (max - min);
                
                if (normalized < 0.33) {
                    return `rgb(239, 68, 68)`;
                } else if (normalized < 0.66) {
                    return `rgb(234, 179, 8)`;
                } else {
                    return `rgb(34, 197, 94)`;
                }
            };

            const filteredPlayers = players.filter(player => {
                if (positionFilter === 'ALL') return true;
                return player.position === positionFilter;
            });

            const sortedPlayers = [...filteredPlayers].sort((a, b) => {
                if (groupByTeam) {
                    if (a.teamId !== b.teamId) return a.teamId - b.teamId;
                    return b.xGI - a.xGI;
                }
                return b.xGI - a.xGI;
            });

            const xGIValues = filteredPlayers.map(p => p.xGI);
            const minXGI = Math.min(...xGIValues);
            const maxXGI = Math.max(...xGIValues);

            const allXGCValues = teams.flatMap(team => 
                team.fixtures.map(f => parseFloat(f.xgc))
            ).filter(val => !isNaN(val));
            const minXGC = Math.min(...allXGCValues);
            const maxXGC = Math.max(...allXGCValues);

            const avgXGCValues = teams.map(t => t.avgXGC).filter(val => !isNaN(val));
            const minAvgXGC = Math.min(...avgXGCValues);
            const maxAvgXGC = Math.max(...avgXGCValues);

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 mb-6 shadow-2xl border border-white/20">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-4xl font-bold text-white mb-2">Premier League xG Dashboard</h1>
                                    <p className="text-purple-200">Expected Goals Analytics • Powered by FPL API</p>
                                    {lastUpdated && (
                                        <p className="text-purple-300 text-sm mt-1">
                                            Last updated: {lastUpdated.toLocaleString()}
                                        </p>
                                    )}
                                </div>
                                <button
                                    onClick={fetchData}
                                    disabled={loading}
                                    className="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition-all disabled:opacity-50"
                                >
                                    <RefreshCw className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />
                                    Refresh Data
                                </button>
                            </div>
                        </div>

                        <div className="flex gap-4 mb-6">
                            <button
                                onClick={() => setActiveTab('teams')}
                                className={`px-8 py-4 rounded-lg font-semibold transition-all ${
                                    activeTab === 'teams'
                                        ? 'bg-white text-purple-900 shadow-lg'
                                        : 'bg-white/10 text-white hover:bg-white/20'
                                }`}
                            >
                                Teams (xGC)
                            </button>
                            <button
                                onClick={() => setActiveTab('players')}
                                className={`px-8 py-4 rounded-lg font-semibold transition-all ${
                                    activeTab === 'players'
                                        ? 'bg-white text-purple-900 shadow-lg'
                                        : 'bg-white/10 text-white hover:bg-white/20'
                                }`}
                            >
                                Players (xG/xA/xGI)
                            </button>
                        </div>

                        {loading ? (
                            <div className="bg-white/10 backdrop-blur-md rounded-xl p-12 text-center">
                                <RefreshCw className="w-12 h-12 text-white animate-spin mx-auto mb-4" />
                                <p className="text-white text-xl">Loading Premier League data...</p>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'teams' && (
                                    <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-2xl border border-white/20">
                                        <h2 className="text-2xl font-bold text-white mb-6">Teams - Expected Goals Conceded (Last 6 Matches)</h2>
                                        
                                        <div className="grid grid-cols-1 gap-6">
                                            {teams
                                                .filter(team => team.fixtures.length > 0)
                                                .sort((a, b) => a.avgXGC - b.avgXGC)
                                                .map(team => {
                                                    const avgColor = getColorForXGC(team.avgXGC, minAvgXGC, maxAvgXGC);
                                                    
                                                    return (
                                                        <div key={team.id} className="bg-white/5 rounded-lg p-5 border border-white/10">
                                                            <div className="flex justify-between items-center mb-4">
                                                                <h3 className="text-white font-bold text-xl">{team.name}</h3>
                                                                <div className="text-right">
                                                                    <div className="text-purple-200 text-sm">Avg xGC (Last 6)</div>
                                                                    <div 
                                                                        className="text-white font-bold text-2xl px-4 py-1 rounded-lg inline-block"
                                                                        style={{ backgroundColor: avgColor }}
                                                                    >
                                                                        {team.avgXGC.toFixed(2)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                                                {team.fixtures.map((fixture, idx) => {
                                                                    const xgcColor = getColorForXGC(parseFloat(fixture.xgc), minXGC, maxXGC);
                                                                    
                                                                    return (
                                                                        <div 
                                                                            key={idx} 
                                                                            className="bg-white/10 rounded-lg p-3 border border-white/20"
                                                                        >
                                                                            <div className="flex items-center gap-2 mb-2">
                                                                                {fixture.isHome ? (
                                                                                    <Home className="w-4 h-4 text-green-400" />
                                                                                ) : (
                                                                                    <Plane className="w-4 h-4 text-blue-400" />
                                                                                )}
                                                                                <span className="text-white font-semibold text-sm">
                                                                                    vs {fixture.opponent}
                                                                                </span>
                                                                            </div>
                                                                            <div className="text-purple-200 text-xs mb-2">
                                                                                GW{fixture.gameweek} • {fixture.score}
                                                                            </div>
                                                                            <div 
                                                                                className="text-white font-bold text-center py-2 rounded"
                                                                                style={{ backgroundColor: xgcColor }}
                                                                            >
                                                                                xGC: {fixture.xgc}
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'players' && (
                                    <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-2xl border border-white/20">
                                        <div className="flex justify-between items-center mb-6 flex-wrap gap-4">
                                            <h2 className="text-2xl font-bold text-white">Players - Expected Goals Analytics</h2>
                                            <div className="flex gap-3">
                                                <select
                                                    value={positionFilter}
                                                    onChange={(e) => setPositionFilter(e.target.value)}
                                                    className="bg-white/20 text-white px-4 py-2 rounded-lg border border-white/30"
                                                >
                                                    <option value="ALL">All Positions</option>
                                                    <option value="GK">Goalkeepers</option>
                                                    <option value="DEF">Defenders</option>
                                                    <option value="MID">Midfielders</option>
                                                    <option value="FWD">Forwards</option>
                                                </select>
                                                <button
                                                    onClick={() => setGroupByTeam(!groupByTeam)}
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                                        groupByTeam
                                                            ? 'bg-white text-purple-900'
                                                            : 'bg-white/20 text-white hover:bg-white/30'
                                                    }`}
                                                >
                                                    {groupByTeam ? 'Grouped by Team' : 'Group by Team'}
                                                </button>
                                            </div>
                                        </div>

                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead>
                                                    <tr className="border-b border-white/20">
                                                        <th className="text-left text-white font-semibold p-3">Player</th>
                                                        <th className="text-left text-white font-semibold p-3">Team</th>
                                                        <th className="text-left text-white font-semibold p-3">Pos</th>
                                                        <th className="text-center text-white font-semibold p-3">xG</th>
                                                        <th className="text-center text-white font-semibold p-3">xA</th>
                                                        <th className="text-center text-white font-semibold p-3">xGI</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {sortedPlayers.map((player, idx) => {
                                                        const xGIColor = getColorForValue(player.xGI, minXGI, maxXGI);
                                                        const showTeamDivider = groupByTeam && idx > 0 && 
                                                            sortedPlayers[idx - 1].teamId !== player.teamId;
                                                        
                                                        return (
                                                            <Fragment key={player.id}>
                                                                {showTeamDivider && (
                                                                    <tr>
                                                                        <td colSpan="6" className="p-2 bg-white/5"></td>
                                                                    </tr>
                                                                )}
                                                                <tr className="border-b border-white/10 hover:bg-white/5 transition-colors">
                                                                    <td className="text-white p-3">{player.name}</td>
                                                                    <td className="text-purple-200 p-3 text-sm">{player.team}</td>
                                                                    <td className="text-purple-300 p-3 text-sm font-medium">{player.position}</td>
                                                                    <td className="text-center p-3">
                                                                        <span className="text-white font-semibold">
                                                                            {player.xG.toFixed(2)}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center p-3">
                                                                        <span className="text-white font-semibold">
                                                                            {player.xA.toFixed(2)}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center p-3">
                                                                        <span 
                                                                            className="px-3 py-1 rounded-full font-bold text-white"
                                                                            style={{ backgroundColor: xGIColor }}
                                                                        >
                                                                            {player.xGI.toFixed(2)}
                                                                        </span>
                                                                    </td>
                                                                </tr>
                                                            </Fragment>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        <div className="mt-6 bg-white/10 backdrop-blur-md rounded-xl p-4 border border-white/20">
                            <p className="text-white text-sm mb-2">
                                <strong>Teams (xGC) Color Guide:</strong> <span className="text-green-400">Green = Low xGC (Good Defense)</span> • 
                                <span className="text-yellow-400 ml-2">Yellow = Medium xGC</span> • 
                                <span className="text-red-400 ml-2">Red = High xGC (Poor Defense)</span>
                            </p>
                            <p className="text-white text-sm">
                                <strong>Players (xGI) Color Guide:</strong> <span className="text-green-400">Green = High values (Best Performers)</span> • 
                                <span className="text-yellow-400 ml-2">Yellow = Medium values</span> • 
                                <span className="text-red-400 ml-2">Red = Low values</span>
                            </p>
                            <p className="text-purple-200 text-xs mt-2">
                                xG = Expected Goals | xA = Expected Assists | xGI = Expected Goal Involvements | xGC = Expected Goals Conceded
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PremierLeagueDashboard />);
    </script>
</body>
</html>